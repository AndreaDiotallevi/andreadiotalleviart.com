---
export const prerender = true

import { getStripeProducts } from "@utils/serverless"
import ProductView from "@components/shop/ProductView.astro"
import type { Currency } from "@utils/stripe"
import { supportedLocales, defaultLocale, localeToCurrency } from "@utils/currency"

export async function getStaticPaths() {
    const products = await getStripeProducts()
    return products.flatMap(product =>
        supportedLocales.filter(locale => locale !== defaultLocale).map(locale => ({
            params: {
                locale,
                category: product.metadata.category,
                slug: product.metadata.slug,
            },
        })),
    )
}

const { slug } = Astro.params
const locale = Astro.params.locale as keyof typeof localeToCurrency
const currency = localeToCurrency[locale] as Currency
const products = await getStripeProducts()

const product = products.filter(product => product.metadata.slug === slug)[0]

if (!product) return Astro.redirect("/404")
---

<ProductView locale={String(locale)} currency={currency} product={product} />
