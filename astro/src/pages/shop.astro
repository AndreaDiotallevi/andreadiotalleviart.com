---
export const prerender = false

import { Image } from "@unpic/astro"
import BaseLayout from "@layouts/BaseLayout.astro"
import { imageBreakpoints } from "@utils/breakpoints"
import { getStripeProducts } from "@utils/serverless"
import { combinedCountries, getLocalCurrency } from "@utils/currency"
import { formatCurrency } from "@utils/intl"
import { sizeToDescription } from "@utils/sizes"

const products = await getStripeProducts()

if (
    import.meta.env.CONTEXT === "production" ||
    import.meta.env.CONTEXT === "staging"
) {
    console.log(Astro.url.href)
    console.log(JSON.stringify(Astro.locals.netlify.context.geo))
}

const currency = getLocalCurrency(
    Astro.locals.netlify.context.geo.country?.code
)

Astro.response.headers.set(
    "cache-control",
    "public, max-age=0, must-revalidate"
)
Astro.response.headers.set(
    "netlify-cdn-cache-control",
    "public, durable, s-maxage=31536000"
)
Astro.response.headers.set("netlify-vary", `country=${combinedCountries}`)
Astro.response.headers.set("netlify-cache-tag", "stripe")
---

<BaseLayout
    title="Shop | Giclée Fine Art Prints | Andrea Diotallevi Art"
    description="Generative giclée fine art prints on Hahnemühle Photo Rag 308gsm. Museum-quality, archival inks. Free carbon‑neutral shipping."
    image={products[0] ? products[0].images[0] : undefined}
    tags={[
        "Generative art prints",
        "Generative art",
        "p5.js",
        "Processing",
        "Procedural",
        "Prints",
        "Fine art",
        "Giclee",
        "Abstract art",
        "Geometric art",
        "Hahnemühle photo rag",
        "Archival inks",
        "Carbon neutral",
        "Free shipping",
    ]}
    newsletter={false}
>
    <div class="max-w-screen-xl mx-auto px-4 py-8 pt-0 md:pt-8 text-gray-800">
        <div class="text-center mb-4 md:mb-6">
            <h1 class="text-2xl md:text-5xl font-bold mb-2 md:mb-5">Shop</h1>
            <p class="max-w-[400px] mx-auto text-sm md:text-base">
                Museum-quality prints on premium cotton paper delivered with
                free shipping
            </p>
        </div>

        <div
            class="grid grid-cols-2 gap-x-2 gap-y-8"
        >
            {
                products
                    .sort(
                        (a, b) =>
                            parseInt(a.metadata.displayOrder) -
                            parseInt(b.metadata.displayOrder)
                    )
                    .map((product, index) => (
                        <a
                            href={`/shop/${product.metadata.category}/${product.metadata.slug}`}
                            class="flex flex-col no-underline text-gray-800 md:hover:opacity-70 transition-opacity duration-300"
                        >
                            <div class="bg-gray-100 p-6 sm:p-10 md:p-15 lg:p-20 flex items-center justify-center">
                                <Image
                                    alt={product.name}
                                    src={product.images[0]}
                                    width={1429}
                                    height={2000}
                                    sizes="(max-width: 1280px) 200vw, 100vw"
                                    breakpoints={imageBreakpoints({
                                        maxWidth: 735,
                                        assetWidth: 1414,
                                    })}
                                    loading={index < 4 ? "eager" : "lazy"}
                                    fetchpriority={index < 4 ? "high" : "low"}
                                    class="shadow-md max-h-[500px] object-contain"
                                />
                            </div>
                            <p class="font-bold md:text-2xl mt-2 md:mt-4">
                                {product.metadata.displayName}
                            </p>
                           
                            <p class="font-semibold text-sm md:text-base md:mt-1">
                                {formatCurrency({
                                    value: product.default_price
                                        .currency_options[currency].unit_amount,
                                    currency,
                                })}
                            </p>

                             <p class="text-sm md:text-base md:mt-1 text-gray-600">
                                {sizeToDescription[product.metadata.size]}
                            </p>
                        </a>
                    ))
            }
        </div>
    </div>
</BaseLayout>
