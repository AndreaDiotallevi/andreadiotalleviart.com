---
import BaseLayout from "@layouts/BaseLayout.astro"
---

<BaseLayout
    title="Checkout | Andrea Diotallevi Art"
    description="Complete your purchase quickly and securely with Stripe. Our streamlined checkout process is safe and easy, ensuring your details are protected."
    hideFooter={true}
    noIndex={true}
>
    <div class="max-w-screen-xl mx-auto px-4 py-8 pt-0 md:pt-8">
        <h1 class="text-center text-2xl md:text-5xl font-bold mb-4 md:mb-6">
            Checkout
        </h1>
        <div id="checkout"></div>
    </div>
</BaseLayout>

<script>
    import { loadStripe, type StripeEmbeddedCheckout } from "@stripe/stripe-js"
    import { getStripeProducts, createCheckoutSession } from "@utils/serverless"
    import { updateClientSession } from "@utils/localStorage"

    let checkout: StripeEmbeddedCheckout | undefined

    document.addEventListener("astro:page-load", async () => {
        const checkoutElement = document.querySelector("#checkout") as HTMLElement
        if (!checkoutElement) return

        const stripe = await loadStripe(
            import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY
        )

        const params = new URLSearchParams(window.location.search)
        const clientSecret = params.get("client_secret")
        const productsParam = params.get("products")
        const couponParam = params.get("coupon") || undefined

        if (stripe && clientSecret && checkoutElement) {
            if (checkout) checkout.destroy()
            checkout = await stripe.initEmbeddedCheckout({ clientSecret })
            checkout.mount(checkoutElement)
            return
        }

        // If we don't yet have a client secret but products are provided, create a session and redirect
        if (productsParam) {
            try {
                const items = productsParam
                    .split(",")
                    .map(pair => pair.split(":"))
                    .map(([sku, qty]) => ({
                        sku: (sku || "").trim(),
                        quantity: Number.parseInt(qty || "1", 10) || 1,
                    }))
                    .filter(item => item.sku && item.quantity > 0)

                if (items.length === 0) return

                const products = await getStripeProducts()
                const skuToPriceId = new Map(
                    products.map(p => [p.metadata.sku, p.default_price.id]),
                )

                const line_items = items
                    .map(item => {
                        const priceId = skuToPriceId.get(item.sku)
                        if (!priceId) return null
                        return { price: priceId, quantity: item.quantity }
                    })
                    .filter(Boolean) as { price: string; quantity: number }[]

                if (line_items.length === 0) return

                const { session, error } = await createCheckoutSession({
                    line_items,
                    success_url: `${window.location.origin}/checkout/success`,
                    currency: "gbp",
                    promotion_code: couponParam,
                })

                if (error || !session || !session.client_secret) {
                    console.error("Failed to create session", error)
                    return
                }

                // Persist session locally (also syncs stored locale from session currency)
                updateClientSession({ session, promotionCode: couponParam || "" })

                const nextUrl = new URL(window.location.href)
                nextUrl.searchParams.delete("products")
                nextUrl.searchParams.delete("coupon")
                nextUrl.searchParams.set("client_secret", session.client_secret)
                window.location.replace(nextUrl.toString())
            } catch (err) {
                console.error("Error creating checkout session from products", err)
            }
        }
    })
</script>
