---
export const prerender = false

import { Image } from "@unpic/astro"
import BaseLayout from "@layouts/BaseLayout.astro"
import { currencyToLocale, defaultLocale } from "@utils/currency"

import { imageBreakpoints } from "@utils/breakpoints"
import { formatCurrency } from "@utils/intl"
import { retrieveCheckoutSession } from "@utils/serverless"
import type { StripePrice } from "@utils/stripe"

const sessionId = Astro.url.searchParams.get("session_id") || ""
const { session } = await retrieveCheckoutSession({ sessionId })

const currency = session?.currency
const locale = currency ? currencyToLocale[(currency as string).toLowerCase() as keyof typeof currencyToLocale] : defaultLocale
const shippingDetails = session?.shipping_details

const success = !!(session && currency && shippingDetails)
---

<BaseLayout
    title="Checkout Success | Andrea Diotallevi Art"
    description="Your order was successful. Check your email for order details and shipping information."
    noIndex={true}
>
    <div
        id="success-page-content"
        class="max-w-screen-sm mx-auto px-4 py-8 pt-0 md:pt-8 text-gray-800"
        data-session={JSON.stringify(session)}
    >
        {
            success ? (
                <>
                    <div class="w-full">
                        <h1 class="text-2xl md:text-5xl font-bold mb-4 md:mb-6">
                            Your order was successful
                        </h1>
                        <div class="space-y-6">
                            <div class="space-y-2">
                                <p>Order number: <span class="font-bold">{session.metadata?.orderNumber}</span>.</p>
                                <p>
                                    You will receive a confirmation email with
                                    the details of your order.
                                </p>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold mb-2">
                                    Delivery address
                                </h2>
                                <div class="space-y-2">
                                    <p>{shippingDetails.name}</p>
                                    <p>
                                        {shippingDetails.address?.line1
                                            ? `${shippingDetails.address?.line1}, `
                                            : ""}
                                        {shippingDetails.address?.line2
                                            ? `${shippingDetails.address?.line2}, `
                                            : ""}
                                        {shippingDetails.address?.postal_code
                                            ? `${shippingDetails.address?.postal_code}, `
                                            : ""}
                                        {shippingDetails.address?.city
                                            ? `${shippingDetails.address?.city}, `
                                            : ""}
                                        {shippingDetails.address?.country
                                            ? `${shippingDetails.address?.country}`
                                            : ""}
                                    </p>
                                </div>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold mb-2">Items</h2>
                                <ol class="list-none space-y-4">
                                    {session.line_items?.data.map(item => {
                                        const price =
                                            item.price as unknown as StripePrice

                                        return (
                                            <li class="flex">
                                                <div class="w-[60px] flex-shrink-0">
                                                    <Image
                                                        alt={price.product.name}
                                                        src={
                                                            price.product
                                                                .images[0]
                                                        }
                                                        width={1414}
                                                        height={2000}
                                                        layout="constrained"
                                                        sizes="60px"
                                                        breakpoints={imageBreakpoints(
                                                            {
                                                                maxWidth: 300,
                                                                assetWidth: 1414,
                                                            }
                                                        )}
                                                        loading="eager"
                                                        fetchpriority="high"
                                                    />
                                                </div>
                                                <p class="pl-4">
                                                    {item.quantity} x{" "}
                                                    {
                                                        price.product.metadata
                                                            .displayName
                                                    }{" "}
                                                    -{" "}
                                                    {price.product.description}
                                                </p>
                                            </li>
                                        )
                                    })}
                                </ol>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold mb-2">
                                    Payment summary
                                </h2>
                                <p>
                                    Subtotal:{" "}
                                    {formatCurrency({
                                        value: session.amount_subtotal!,
                                        currency,
                                    })}
                                    <br />
                                    Shipping: Free
                                    <br />
                                    Discounts:{" "}
                                    {formatCurrency({
                                        value: session.total_details
                                            ?.amount_discount!,
                                        currency,
                                    })}
                                    <br />
                                    <span class="font-bold">Total:{" "}
                                    {formatCurrency({
                                        value: session.amount_total!,
                                        currency,
                                    })}</span>
                                </p>
                            </div>
                        </div>

                        <div class="mt-6">
                            <a
                                href={`/${locale}/shop`}
                                class="block w-full px-4 py-3 text-white bg-gray-800 rounded-lg md:hover:bg-gray-800 text-center font-bold transition-colors duration-300"
                            >
                                Discover more
                            </a>
                        </div>
                    </div>
                </>
            ) : (
                <p class="font-bold min-h-[48px] border border-red-600 rounded-md bg-red-100 text-red-800 flex items-center px-4 py-2">
                    There was an error retrieving your session. Please try
                    refreshing the page.
                </p>
            )
        }
    </div>
</BaseLayout>

<script>
    import type Stripe from "stripe"
    import { sendGA4PurchaseEvent } from "@utils/ga4"
    import { clearClientSession } from "@utils/localStorage"

    document.addEventListener("astro:page-load", async () => {
        
        const successPageContent = document.querySelector(
            "#success-page-content"
        ) as HTMLElement
        
        if (!successPageContent) return
        
        clearClientSession()

        // Ensure cart badge reflects cleared session on this page
        const hideBadges = () => {
            const spans = document.querySelectorAll(
                ".shopping-cart span"
            ) as NodeListOf<HTMLSpanElement>
            spans.forEach(span => {
                span.textContent = ""
                span.classList.add("hidden")
            })
        }
        // Run immediately and once more after other listeners
        hideBadges()
        setTimeout(hideBadges, 0)
        
        const session = JSON.parse(
            successPageContent.dataset.session!
        ) as Stripe.Checkout.Session

        if (session) {
            sendGA4PurchaseEvent({ session })
        }
    })
</script>
