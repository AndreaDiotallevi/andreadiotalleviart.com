---
export const prerender = true

import { Image } from "@unpic/astro"
import BaseLayout from "@layouts/BaseLayout.astro"
import { imageBreakpoints } from "@utils/breakpoints"
import { getStripeProducts } from "@utils/serverless"
import { formatCurrency } from "@utils/intl"
import { sizeToDescription } from "@utils/sizes"
import type { Currency } from "@utils/stripe"

export async function getStaticPaths() {
    const currencies = ["gbp", "eur", "usd"]
    return currencies.map(currency => ({ params: { currency } }))
}

const currency = Astro.params.currency as Currency
const products = await getStripeProducts()
---

<BaseLayout
    title="Shop | Giclée Fine Art Prints | Andrea Diotallevi Art"
    description="Generative giclée fine art prints on Hahnemühle Photo Rag 308gsm. Museum-quality, archival inks. Free carbon‑neutral shipping."
    image={products[0] ? products[0].images[0] : undefined}
    tags={[
        "Generative art prints",
        "Generative art",
        "p5.js",
        "Processing",
        "Procedural",
        "Prints",
        "Fine art",
        "Giclee",
        "Abstract art",
        "Geometric art",
        "Hahnemühle photo rag",
        "Archival inks",
        "Carbon neutral",
        "Free shipping",
    ]}
    newsletter={false}
>
    <div class="max-w-screen-xl mx-auto px-4 py-8 pt-0 md:pt-8 text-gray-800">
        <div class="relative mb-2 md:mb-3 text-center">
            <h1 class="text-2xl md:text-5xl font-bold">Shop</h1>
        </div>
        <p class="max-w-[400px] mx-auto text-center text-sm md:text-base mt-2 mb-3">
            Museum-quality prints on premium cotton paper delivered with
            free shipping
        </p>
        <div class="flex md:hidden items-center justify-end mb-3">
            <label for="currency-selector-mobile" class="sr-only">Currency</label>
            <select id="currency-selector-mobile" aria-label="Currency" data-currency-selector class="border border-gray-300 rounded px-2 py-1 text-sm font-semibold">
                <option value="gbp" selected={currency === "gbp"}>GBP (£)</option>
                <option value="eur" selected={currency === "eur"}>EUR (€)</option>
                <option value="usd" selected={currency === "usd"}>USD ($)</option>
            </select>
        </div>
        <div class="hidden md:flex items-center justify-end mb-4">
            <label for="currency-selector-desktop" class="sr-only">Currency</label>
            <select id="currency-selector-desktop" aria-label="Currency" data-currency-selector class="border border-gray-300 rounded px-2 py-1 text-sm md:text-base font-semibold">
                <option value="gbp" selected={currency === "gbp"}>GBP (£)</option>
                <option value="eur" selected={currency === "eur"}>EUR (€)</option>
                <option value="usd" selected={currency === "usd"}>USD ($)</option>
            </select>
        </div>

        <div
            class="grid grid-cols-2 gap-x-2 gap-y-8"
        >
            {
                products
                    .sort(
                        (a, b) =>
                            parseInt(a.metadata.displayOrder) -
                            parseInt(b.metadata.displayOrder)
                    )
                    .map((product, index) => (
                        <a
                            href={`/${currency}/shop/${product.metadata.category}/${product.metadata.slug}`}
                            class="flex flex-col no-underline text-gray-800 md:hover:opacity-70 transition-opacity duration-300"
                        >
                            <div class="bg-gray-100 p-6 sm:p-10 md:p-15 lg:p-20 flex items-center justify-center">
                                <Image
                                    alt={product.name}
                                    src={product.images[0]}
                                    width={1429}
                                    height={2000}
                                    sizes="(max-width: 1280px) 200vw, 100vw"
                                    breakpoints={imageBreakpoints({
                                        maxWidth: 735,
                                        assetWidth: 1414,
                                    })}
                                    loading={index < 4 ? "eager" : "lazy"}
                                    fetchpriority={index < 4 ? "high" : "low"}
                                    class="shadow-md max-h-[500px] object-contain"
                                />
                            </div>
                            <p class="font-bold md:text-2xl mt-2 md:mt-4">
                                {product.metadata.displayName}
                            </p>
                           
                            <p class="font-semibold text-sm md:text-base md:mt-1">
                                {formatCurrency({
                                    value: product.default_price
                                        .currency_options[currency].unit_amount,
                                    currency,
                                })}
                            </p>

                             <p class="text-sm md:text-base md:mt-1 text-gray-600">
                                {sizeToDescription[product.metadata.size]}
                            </p>
                        </a>
                    ))
            }
        </div>
    </div>
</BaseLayout>

<script>
    import { recreateSessionWithCurrency } from "@scripts/cart"
    import { navigate } from "astro:transitions/client"
    import { setStoredCurrency } from "@utils/localStorage"

    document.addEventListener("astro:page-load", () => {
        const selectors = document.querySelectorAll('[data-currency-selector]') as NodeListOf<HTMLSelectElement>
        if (!selectors.length) return

        const currentCurrency = (window.location.pathname.split("/")[1] || "gbp").toLowerCase()
        const initial = ["gbp", "eur", "usd"].includes(currentCurrency) ? currentCurrency : "gbp"
        selectors.forEach(sel => (sel.value = initial))

        selectors.forEach(sel => {
            sel.addEventListener("change", async () => {
                const currency = sel.value
                setStoredCurrency(currency as any)
                await recreateSessionWithCurrency({ currency: currency as any })
                navigate(`/${currency}/shop`)
            })
        })
    })
    </script>
