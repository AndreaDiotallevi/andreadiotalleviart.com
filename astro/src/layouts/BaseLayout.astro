---
import { ClientRouter } from "astro:transitions"

import type { Currency } from "@utils/stripe"
import { generateStructuredData } from "@utils/structuredData"
import GlobalStyles from "@components/GlobalStyles.astro"
import NavigationLayout from "./NavigationLayout.astro"
import { supportedLocales, defaultLocale, localeToCurrency } from "@utils/currency"

const ga4TrackingID: string = import.meta.env.GA4_TRACKING_ID
const canonicalURL = new URL(Astro.url.pathname, Astro.site)
const siteOrigin = canonicalURL.origin

function removeHtmlExtension(url: string) {
    if (url.endsWith(".html")) {
        return url.slice(0, -5)
    }
    if (url.endsWith("/")) {
        return url.slice(0, -1)
    }
    return url
}

const cleanedUrl = removeHtmlExtension(canonicalURL.href)

const pathParts = Astro.url.pathname.split("/").filter(Boolean)
const firstSeg = (pathParts[0] || "").toLowerCase()
const isPrefixed = (supportedLocales as unknown as string[]).includes(firstSeg)
const currentLocaleFromPath = isPrefixed ? (firstSeg as keyof typeof localeToCurrency) : null
const restSegments = isPrefixed ? pathParts.slice(1) : pathParts
const restPath = restSegments.join("/") // no leading slash

const makeLocalizedPath = (locale: string) => {
    if (!restPath) {
        return locale === defaultLocale ? "/" : `/${locale}`
    }
    return locale === defaultLocale ? `/${restPath}` : `/${locale}/${restPath}`
}

const alternateLinks = (supportedLocales as unknown as string[]).map(l => ({
    hreflang: l,
    href: removeHtmlExtension(new URL(makeLocalizedPath(l), Astro.site).href),
}))
const xDefaultLink = removeHtmlExtension(
    new URL(makeLocalizedPath(defaultLocale), Astro.site).href,
)

const effectivePageLocale = (currentLocaleFromPath || defaultLocale) as string
const ogLocaleMap: Record<string, string> = {
    "en-gb": "en_GB",
    "en-us": "en_US",
    en: "en",
}
const effectiveOgLocale = ogLocaleMap[effectivePageLocale] || "en_GB"

interface Props {
    title: string
    description: string
    image?: string
    tags?: string[]
    type?: "website" | "product"
    amount?: string
    currency?: Currency
    darkTheme?: boolean
    hideFooter?: boolean
    newsletter?: boolean
    noIndex?: boolean
    productJsonLd?: {
        name: string
        description: string
        imageUrls: string[]
        sku: string
        material?: string
        widthCm?: number
        heightCm?: number
    }
}

const {
    title,
    description,
    image,
    tags = [],
    type = "website",
    amount,
    currency,
    darkTheme = false,
    hideFooter = false,
    newsletter = false,
    noIndex = false,
    productJsonLd,
} = Astro.props

const currencyFromPath = currentLocaleFromPath ? localeToCurrency[currentLocaleFromPath] : undefined
const effectiveCurrency = (currency || currencyFromPath || "gbp") as Currency
---

<!doctype html>
<html lang="en">
    <head>
        {import.meta.env.PUBLIC_ENV === "production" ? (
            <link rel="sitemap" href="/sitemap.xml" />
        ) : null}
        <meta charset="UTF-8" />
        <meta name="description" content={description} />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
        <!-- <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;700&display=swap"
        /> -->
        <title>{title}</title>

        {noIndex || import.meta.env.PUBLIC_ENV !== "production" ? (
            <meta name="robots" content="noindex, nofollow" />
        ) : null}

        <meta name="keywords" content={tags.join(", ")} />
        {image ? <meta name="image" content={image} /> : null}

        <!-- Open Graph Meta Tags -->
        <link rel="canonical" href={cleanedUrl} />
        {alternateLinks.length ? (
            <>
                {alternateLinks.map(link => (
                    <link rel="alternate" hreflang={link.hreflang} href={link.href} />
                ))}
                {xDefaultLink ? (
                    <link rel="alternate" hreflang="x-default" href={xDefaultLink} />
                ) : null}
            </>
        ) : null}
        <meta property="og:url" content={cleanedUrl} />
        <meta property="og:type" content={type} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        {image ? <meta property="og:image" content={image} /> : null}
        <meta property="og:site_name" content="Andrea Diotallevi Art" />
        <meta property="og:locale" content={effectiveOgLocale} />

        {
            type === "product" && amount && (currency || currencyFromPath) ? (
                <>
                    <meta property="og:price:amount" content={amount} />
                    <meta
                        property="og:price:currency"
                        content={effectiveCurrency.toUpperCase()}
                    />
                    <meta
                        property="og:availability"
                        content="available for order"
                    />
                    <meta property="product:condition" content="new" />
                    <meta property="product:category" content="500044" />
                </>
            ) : null
        }

        <!-- Twitter Card Meta Tags -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:creator" content="@adiotalleviart" />
        <meta name="twitter:title" content={title} />
        <meta name="twitter:description" content={description} />
        {image ? <meta name="twitter:image" content={image} /> : null}

        <!-- Google Site Verification -->
        <meta
            name="google-site-verification"
            content="L9kVJc3DVgxLFGpwKd4inoCjGO9kEnixH9fUaC4DEYY"
        />
        
        <!-- JSON-LD Structured Data: WebSite, Organization, and optionally WebPage/Product -->
        <script
            is:inline
            type="application/ld+json"
            set:html={JSON.stringify(
                generateStructuredData({
                    siteOrigin,
                    pageUrl: cleanedUrl,
                    pageTitle: title,
                    product: type === "product" && productJsonLd ? productJsonLd : undefined,
                    offerPrice: amount ?? "0",
                    offerCurrency: effectiveCurrency,
                    pageLocale: (currentLocaleFromPath || defaultLocale) as string,
                })
            )}
        ></script>

        <!-- Google tag (gtag.js) -->
        <script
            is:inline
            src=`https://www.googletagmanager.com/gtag/js?id=${ga4TrackingID}`
        ></script>
        <script is:inline define:vars={{ ga4TrackingID }}>
            document.addEventListener("astro:page-load", () => {
                window.dataLayer = window.dataLayer || []
                window.gtag = function gtag() {
                    dataLayer.push(arguments)
                }
                window.gtag("js", new Date())
                window.gtag("config", ga4TrackingID)
            })
        </script>

        <!-- Meta Business Suite Verification -->
        <meta name="facebook-domain-verification" content="ej8fsgb4qp1xpgr8wih0swxplajmhp" />

        <ClientRouter />
    </head>
    <body class="min-w-[320px]">
        <GlobalStyles />
        <NavigationLayout
            darkTheme={darkTheme}
            hideFooter={hideFooter}
            newsletter={newsletter}
        >
            <slot />
        </NavigationLayout>
    </body>
</html>

<script>
    import { setStoredLocale } from "@utils/localStorage"
    import { supportedLocales, defaultLocale } from "@utils/currency"

    document.addEventListener("astro:page-load", () => {
        const firstSeg = (window.location.pathname.split("/")[1] || "").toLowerCase()
        const newLocale = (supportedLocales as unknown as string[]).includes(firstSeg)
            ? firstSeg
            : defaultLocale
        setStoredLocale(newLocale as any)
    })
</script>
