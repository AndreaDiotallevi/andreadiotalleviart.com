---
import Newsletter from "@components/Newsletter.astro"
import ShoppingCart from "@components/ShoppingCart.astro"
import { defaultLocale, buildLocaleUrl } from "@utils/currency"

interface Props {
    darkTheme?: boolean
    hideFooter?: boolean
    newsletter?: boolean
}

const { darkTheme, hideFooter, newsletter } = Astro.props

// Determine current locale from path for SSR hrefs
const pathParts = Astro.url.pathname.split("/").filter(Boolean)
const firstSeg = (pathParts[0] || "").toLowerCase()
import { supportedLocales } from "@utils/currency"
const currentLocale = ((supportedLocales as unknown as string[]).includes(firstSeg) ? firstSeg : defaultLocale) as string
const shopHref = buildLocaleUrl('/shop', currentLocale as any)
---

<div
    class={`flex flex-col min-h-[100dvh] ${darkTheme ? "bg-[#38444c] text-white" : "bg-white text-gray-800"}`}
>
    <header
        class={`fixed top-0 flex items-center justify-center w-full min-w-[320px] h-20 ${darkTheme ? "" : "bg-white bg-opacity-70 backdrop-blur-md"} z-50`}
    >
        <div
            class="max-w-screen-xl mx-auto flex items-center justify-between w-full px-4"
        >
            <div
                class={`md:text-2xl font-bold ${darkTheme ? "md:hover:text-gray-300" : "md:hover:text-gray-600"} transition-colors duration-300`}
            >
                <a href="/">andreadiotalleviart</a>
            </div>
            <div class="flex items-center">
                    <a
                        id="cart-link-mobile"
                        href="/cart"
                        class="md:hidden pr-4"
                        aria-label="See shopping cart"
                    >
                        <ShoppingCart darkTheme={darkTheme} />
                    </a>
                <!-- Hamburger icon -->
                <button
                    id="menu-toggle"
                    class="md:hidden"
                    aria-label="menu-toggle"
                >
                    <svg
                        class="w-11 h-11"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>

            <!-- Links for larger screens -->
            <nav class="hidden md:flex space-x-7">
                <a
                    href={shopHref}
                    class={`text-2xl font-bold ${darkTheme ? "md:hover:text-gray-300" : "md:hover:text-gray-600"} transition-colors duration-300`}
                    >shop</a>
                <a
                    href="/about"
                    class={`text-2xl font-bold ${darkTheme ? "md:hover:text-gray-300" : "md:hover:text-gray-600"} transition-colors duration-300`}
                    >about</a
                >
                <a
                    href="/contact"
                    class={`text-2xl font-bold ${darkTheme ? "md:hover:text-gray-300" : "md:hover:text-gray-600"} transition-colors duration-300`}
                    >contact</a
                >
                <a
                    href="/portfolio"
                    class={`text-2xl font-bold ${darkTheme ? "md:hover:text-gray-300" : "md:hover:text-gray-600"} transition-colors duration-300`}
                    >portfolio</a
                >
                <a
                    id="cart-link-desktop"
                    href="/cart"
                    aria-label="See shopping cart"
                >
                    <ShoppingCart darkTheme={darkTheme} />
                </a>
            </nav>
        </div>
    </header>

    <!-- Fullscreen mobile menu -->
    <div
        id="mobile-menu"
        class="fixed inset-0 bg-[#38444c] min-w-[320px] text-white flex flex-col items-center pt-20 px-5 text-4xl hidden z-50"
    >
        <button
            id="menu-close"
            class="absolute top-[14px] right-[16px] text-white text-5xl h-11 w-11"
            >&times;</button
        >
        <a href={shopHref} class="mb-6">Shop</a>
        <a href="/about" class="mb-6">About</a>
        <a href="/contact" class="mb-6">Contact</a>
        <a href="/portfolio" class="mb-6">Portfolio</a>
    </div>

    <main class="flex-grow pt-[80px]">
        <slot />
    </main>

    {newsletter && <Newsletter />}

    <footer
        class={`flex items-center justify-center h-20 ${hideFooter ? "hidden md:flex" : ""}`}
    >
        <div
            class="max-w-screen-xl mx-auto flex items-center justify-between w-full px-4"
        >
            <p class="text-sm">Â© 2025 Andrea&nbsp;Diotallevi</p>
            <div class="flex space-x-0 md:space-x-2">
                <a
                    href="https://github.com/AndreaDiotallevi/andreadiotalleviart.com"
                    target="_blank"
                    class={`w-12 h-12 flex items-center justify-end ${darkTheme ? "md:hover:text-gray-300" : "md:hover:text-gray-600"} transition-colors duration-300`}
                    aria-label="GitHub"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="currentColor"
                        viewBox="0 0 98 96"
                        class="w-6 h-6"
                    >
                        <path
                            d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z"
                        ></path>
                    </svg>
                </a>
                <a
                    href="https://twitter.com/adiotalleviart"
                    target="_blank"
                    class={`w-12 h-12 flex items-center justify-end ${darkTheme ? "md:hover:text-gray-300" : "md:hover:text-gray-600"} transition-colors duration-300`}
                    aria-label="Twitter"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="currentColor"
                        viewBox="0 0 300 271"
                        class="w-6 h-6"
                    >
                        <path
                            d="m236 0h46l-101 115 118 156h-92.6l-72.5-94.8-83 94.8h-46l107-123-113-148h94.9l65.5 86.6zm-16.1 244h25.5l-165-218h-27.4z"
                        ></path>
                    </svg>
                </a>
                <a
                    href="https://www.instagram.com/andreadiotalleviart"
                    target="_blank"
                    class={`w-12 h-12 flex items-center justify-end ${darkTheme ? "md:hover:text-gray-300" : "md:hover:text-gray-600"} transition-colors duration-300`}
                    aria-label="Instagram"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="currentColor"
                        viewBox="0 0 512 512"
                        class="w-6 h-6"
                    >
                        <path
                            d="M256 49.5c67.3 0 75.2.3 101.8 1.5 24.6 1.1 37.9 5.2 46.8 8.7 11.8 4.6 20.2 10 29 18.8s14.3 17.2 18.8 29c3.4 8.9 7.6 22.2 8.7 46.8 1.2 26.6 1.5 34.5 1.5 101.8s-.3 75.2-1.5 101.8c-1.1 24.6-5.2 37.9-8.7 46.8-4.6 11.8-10 20.2-18.8 29s-17.2 14.3-29 18.8c-8.9 3.4-22.2 7.6-46.8 8.7-26.6 1.2-34.5 1.5-101.8 1.5s-75.2-.3-101.8-1.5c-24.6-1.1-37.9-5.2-46.8-8.7-11.8-4.6-20.2-10-29-18.8s-14.3-17.2-18.8-29c-3.4-8.9-7.6-22.2-8.7-46.8-1.2-26.6-1.5-34.5-1.5-101.8s.3-75.2 1.5-101.8c1.1-24.6 5.2-37.9 8.7-46.8 4.6-11.8 10-20.2 18.8-29s17.2-14.3 29-18.8c8.9-3.4 22.2-7.6 46.8-8.7 26.6-1.3 34.5-1.5 101.8-1.5m0-45.4c-68.4 0-77 .3-103.9 1.5C125.3 6.8 107 11.1 91 17.3c-16.6 6.4-30.6 15.1-44.6 29.1-14 14-22.6 28.1-29.1 44.6-6.2 16-10.5 34.3-11.7 61.2C4.4 179 4.1 187.6 4.1 256s.3 77 1.5 103.9c1.2 26.8 5.5 45.1 11.7 61.2 6.4 16.6 15.1 30.6 29.1 44.6 14 14 28.1 22.6 44.6 29.1 16 6.2 34.3 10.5 61.2 11.7 26.9 1.2 35.4 1.5 103.9 1.5s77-.3 103.9-1.5c26.8-1.2 45.1-5.5 61.2-11.7 16.6-6.4 30.6-15.1 44.6-29.1 14-14 22.6-28.1 29.1-44.6 6.2-16 10.5-34.3 11.7-61.2 1.2-26.9 1.5-35.4 1.5-103.9s-.3-77-1.5-103.9c-1.2-26.8-5.5-45.1-11.7-61.2-6.4-16.6-15.1-30.6-29.1-44.6-14-14-28.1-22.6-44.6-29.1-16-6.2-34.3-10.5-61.2-11.7-27-1.1-35.6-1.4-104-1.4z"
                        ></path>
                        <path
                            d="M256 126.6c-71.4 0-129.4 57.9-129.4 129.4s58 129.4 129.4 129.4 129.4-58 129.4-129.4-58-129.4-129.4-129.4zm0 213.4c-46.4 0-84-37.6-84-84s37.6-84 84-84 84 37.6 84 84-37.6 84-84 84z"
                        ></path>
                        <circle cx="390.5" cy="121.5" r="30.2"></circle>
                    </svg>
                </a>
            </div>
        </div>
    </footer>
</div>

<script>
    document.addEventListener("astro:page-load", () => {
        const menuToggle = document.querySelector("#menu-toggle")
        const menuClose = document.querySelector("#menu-close")
        const mobileMenu = document.querySelector("#mobile-menu")

        if (!menuToggle || !menuClose || !mobileMenu) return

        menuToggle.addEventListener("click", () => {
            mobileMenu.classList.remove("hidden")
            document.body.style.overflow = "hidden" // Disable scrolling
        })

        menuClose.addEventListener("click", () => {
            mobileMenu.classList.add("hidden")
            document.body.style.overflow = "auto" // Enable scrolling
        })
    })
</script>

<script>
    // Track previous and current path for smarter history decisions
    document.addEventListener("astro:page-load", () => {
        const current = sessionStorage.getItem("currentPathname") || ""
        sessionStorage.setItem("prevPathname", current)
        sessionStorage.setItem("currentPathname", window.location.pathname)
    })
</script>

<script>
    import { clearClientSession, getClientSession, updateClientSession, getStoredLocale } from "@utils/localStorage"
    import { supportedLocales, defaultLocale } from "@utils/currency"
    import { retrieveCheckoutSession } from "@utils/serverless"

    document.addEventListener("astro:page-load", async () => {
        if (
            window.location.pathname === "/checkout/success" ||
            (window.location.pathname.endsWith("/cart") &&
                !window.location.search.includes("session_id="))
        ) {
            clearClientSession()
        }

        // Locale-based navigation; currency is decided server-side from locale

        // Determine current locale from URL and rewrite Shop links to keep it
        const firstSegment = (window.location.pathname.split("/")[1] || "").toLowerCase()
        const currentLocale = (supportedLocales as unknown as string[]).includes(firstSegment) ? firstSegment : getStoredLocale()
        // Rewrite Shop links to keep locale
        const shopAnchors = document.querySelectorAll(
            'a[href="/shop"], a[href="/shop/"]'
        ) as NodeListOf<HTMLAnchorElement>
        shopAnchors.forEach(a => {
            a.href = currentLocale === 'en-gb' ? '/shop' : `/${currentLocale}/shop`
        })

        let isSyncingFromUrl = false
        let previousBadgeValue: string | null = null

        const updateCartLinksAndBadge = () => {
            const cartLinks = document.querySelectorAll(
                '[id^="cart-link-"]'
            ) as NodeListOf<HTMLAnchorElement>

            const { sessionId, totalQuantity } = getClientSession()

            // Prefer URL session id for href to avoid flicker on back/forward
            const urlSessionId = new URLSearchParams(window.location.search).get("session_id")
            const effectiveSessionId = urlSessionId || sessionId

            cartLinks.forEach(link => {
                if (effectiveSessionId) {
                    link.setAttribute("href", `/cart?session_id=${effectiveSessionId}`)
                } else {
                    link.setAttribute("href", `/cart`)
                }

                const cartItemsSpan = link.querySelector("span") as HTMLSpanElement

                // Smooth transition: avoid hiding immediately on transient 0 during session changes
                const existingTimeout = (cartItemsSpan as any)._hideTimeout as number | undefined
                if (existingTimeout) {
                    clearTimeout(existingTimeout)
                    ;(cartItemsSpan as any)._hideTimeout = undefined
                }

                if (totalQuantity > 0) {
                    cartItemsSpan.textContent = `${totalQuantity}`
                    previousBadgeValue = `${totalQuantity}`
                    cartItemsSpan.classList.remove("hidden")
                } else {
                    // If we're syncing from URL session, keep previous value visible until sync completes
                    if (isSyncingFromUrl && previousBadgeValue) {
                        cartItemsSpan.textContent = previousBadgeValue
                        cartItemsSpan.classList.remove("hidden")
                        return
                    }

                    ;(cartItemsSpan as any)._hideTimeout = window.setTimeout(() => {
                        cartItemsSpan.classList.add("hidden")
                        ;(cartItemsSpan as any)._hideTimeout = undefined
                    }, 400)
                }
            })
        }

        // If URL contains a session_id different from local storage, sync from server then update UI
        const urlSessionId = new URLSearchParams(window.location.search).get("session_id")
        const { sessionId: storedSessionId } = getClientSession()

        // Initial paint
        updateCartLinksAndBadge()

        if (urlSessionId && urlSessionId !== storedSessionId) {
            isSyncingFromUrl = true
            // Paint again using URL session id for href and keeping previous badge visible
            updateCartLinksAndBadge()
            try {
                const { session } = await retrieveCheckoutSession({ sessionId: urlSessionId })
                if (session) {
                    const { promotionCode } = getClientSession()
                    updateClientSession({ session, promotionCode })
                }
            } catch (e) {
                // ignore network errors; UI will reflect stored state
            } finally {
                isSyncingFromUrl = false
                updateCartLinksAndBadge()
            }
        }
    })
</script>
