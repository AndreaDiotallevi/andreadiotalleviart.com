---
import { Image } from "@unpic/astro"

import { imageBreakpoints } from "@utils/breakpoints"
import { getSelectedImageIndex, IMAGE_INDEX_QUERY_PARAM } from "@utils/gallery"

interface Props {
    images: string[]
    width: number
    height: number
    altBase?: string
    selectedIndex?: number
}

const {
    images = [],
    width,
    height,
    altBase,
    selectedIndex: providedSelectedIndex,
} = Astro.props as Props

const totalImages = Array.isArray(images) ? images.length : 0
const selectedImageFromUrl = getSelectedImageIndex(Astro.url, totalImages)
const selectedImageIndex = totalImages
    ? Math.min(
          Math.max(
              typeof providedSelectedIndex === "number"
                  ? providedSelectedIndex
                  : selectedImageFromUrl,
              0,
          ),
          totalImages - 1,
      )
    : 0
const displayedImage = images[selectedImageIndex]

const basePath = Astro.url?.pathname ?? "/"
const baseSearchParams = new URLSearchParams(Astro.url?.searchParams ?? undefined)
baseSearchParams.delete(IMAGE_INDEX_QUERY_PARAM)

const buildHref = (index: number): string => {
    const params = new URLSearchParams(baseSearchParams)
    if (index > 0) {
        params.set(IMAGE_INDEX_QUERY_PARAM, String(index))
    }
    const search = params.toString()
    return search ? `${basePath}?${search}` : basePath
}
---

{displayedImage ? (
    <section class="product-gallery">
        <div class="product-gallery__main" transition:name="product-image">
            <Image
                id={`product-image-index-${selectedImageIndex}`}
                alt={
                    altBase
                        ? `${altBase} - ${selectedImageIndex + 1}`
                        : `Product image ${selectedImageIndex + 1}`
                }
                src={displayedImage}
                width={width}
                height={height}
                loading="eager"
                fetchpriority="high"
                sizes="(max-width: 768px) 200vw, 100vw"
                breakpoints={imageBreakpoints({
                    maxWidth: 1500,
                    assetWidth: width,
                })}
            />
        </div>

        {totalImages > 1 ? (
            <div class="product-gallery__thumbs" role="list">
                {images.map((src, index) => {
                    const isSelected = index === selectedImageIndex
                    return (
                        <a
                            href={buildHref(index)}
                            class={`product-gallery__thumb ${
                                isSelected ? "product-gallery__thumb--selected" : ""
                            }`}
                            aria-current={isSelected ? "true" : undefined}
                            data-astro-prefetch="hover"
                        >
                            <span class="sr-only">
                                Show image {index + 1} of {totalImages}
                            </span>
                            <Image
                                id={`product-thumbnail-index-${index}`}
                                alt={
                                    altBase
                                        ? `Thumbnail of ${altBase} - ${index + 1}`
                                        : `Product thumbnail ${index + 1}`
                                }
                                src={src}
                                width={width}
                                height={height}
                                loading="lazy"
                                fetchpriority="low"
                                sizes="200px"
                                breakpoints={imageBreakpoints({
                                    maxWidth: 600,
                                    assetWidth: width,
                                })}
                            />
                        </a>
                    )
                })}
            </div>
        ) : null}
    </section>
) : null}

<style>
    .product-gallery {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .product-gallery__main {
        border-radius: 1.8rem;
        overflow: hidden;
    }

    .product-gallery__thumbs {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .product-gallery__thumb {
        border-radius: 1.2rem;
        border-bottom: 4px solid transparent;
        display: inline-flex;
        cursor: pointer;
        transition: border-color 150ms ease, opacity 150ms ease;
    }

    .product-gallery__thumb:hover,
    .product-gallery__thumb:focus-visible {
        opacity: 0.8;
    }

    .product-gallery__thumb--selected {
        border-bottom-color: #1f2937;
    }

    @media (max-width: 768px) {
        .product-gallery__thumbs {
            overflow-x: auto;
            padding-bottom: 0.25rem;
        }
    }
</style>
