---
import BaseLayout from "@layouts/BaseLayout.astro"
import BackToLink from "@components/BackToLink.astro"
import Button from "@components/Button.astro"
import Carousel from "@components/Carousel.astro"
import LocaleSelector from "@components/LocaleSelector.astro"
import { formatCurrency } from "@utils/intl"
import { sizeToDescription } from "@utils/sizes"
import { productsData } from "@utils/productsData"
import type { Currency } from "@utils/stripe"
import { buildLocaleUrl } from "@utils/currency"

interface Props {
    locale: string
    currency: Currency
    product: any
}

const { locale, currency, product } = Astro.props as Props
const shopHref = buildLocaleUrl('/shop', locale as any)
---

<BaseLayout
    title={`${product.metadata.displayName} | Giclée Fine Art Print | Andrea Diotallevi Art`}
    description={`${product.metadata.displayName} — generative giclée fine art print on Hahnemühle Photo Rag 308gsm. Museum-quality archival inks. ${sizeToDescription[product.metadata.size]}. Free carbon‑neutral shipping.`}
    image={product.images[0]}
    type="product"
    amount={(product.default_price.currency_options[currency].unit_amount / 100).toFixed(2)}
    currency={currency}
    tags={[
        product.metadata.displayName,
        product.metadata.category,
        "Generative art",
        "Generative art prints",
        "p5.js",
        "Processing",
        "Procedural",
        "Prints",
        "Fine art",
        "Giclee",
        sizeToDescription[product.metadata.size],
        "Abstract art",
        "Geometric art",
        "Hahnemühle Photo Rag 308gsm",
        "Archival inks",
        "Carbon neutral",
        "Free shipping",
    ]}
    newsletter={false}
    productJsonLd={{
        name: `${product.metadata.displayName} (Giclée Print, ${product.metadata.size})`,
        description: `High-quality giclée fine art print of the original artwork '${product.metadata.displayName}'. Printed on archival cotton rag paper using pigment inks. ${sizeToDescription[product.metadata.size]}.`,
        imageUrls: product.images,
        sku: product.metadata.sku,
        material: "Giclée print on archival cotton rag paper",
    }}
>
<div class="flex flex-col md:flex-row items-center md:items-start px-4 py-8 pt-0 md:pt-8 max-w-screen-xl mx-auto text-gray-800">
    <div class="w-full md:w-1/2 mb-6 md:mb-0 md:mr-8">
        <div class="md:hidden flex items-center justify-between mb-4">
            <BackToLink href={shopHref} text="Back to shop" />
            <div class="flex items-center">
                <label for="locale-selector-product-mobile" class="sr-only">Region / language</label>
                <LocaleSelector
                    id="locale-selector-product-mobile"
                    ariaLabel="Region / language"
                    locale={locale}
                    class="border border-gray-300 rounded px-2 py-1 text-sm font-semibold"
                />
            </div>
        </div>
        <div class="mb-4 md:hidden">
            <h1 class="text-2xl font-bold">{product.metadata.displayName}</h1>
            {product.metadata.displaySubtitle? <p class="text-sm mt-1">{product.metadata.displaySubtitle}</p>:<></>}
        </div>
        <Carousel images={product.images} width={1429} height={2000} altBase={product.metadata.displayName} />
        {/* Mobile-only submit button under images */}
        <div class="md:hidden w-full mt-6">
            <h2 class="text-2xl font-bold mb-2">{
                formatCurrency({ value: product.default_price.currency_options[currency].unit_amount, currency })
            }</h2>
            <!-- <p class="mb-4">Apply promotion codes in the cart page.</p> -->
            <Button id="submit-button-mobile" buttonText="Add to cart" errorMessage="There was an error creating your session. Please try again." form="price-form" />
        </div>
    </div>

    <form id="price-form" class="w-full md:w-1/2">
        <div class="hidden md:flex items-start justify-between mb-6">
            <div>
                <h1 class="text-5xl font-bold">{product.metadata.displayName}</h1>
                {product.metadata.displaySubtitle? <p class="font-normal mt-2">{product.metadata.displaySubtitle}</p>:<></>}
            </div>
            <div class="flex items-center">
                <label for="locale-selector-product" class="sr-only">Region / language</label>
                <LocaleSelector
                    id="locale-selector-product"
                    ariaLabel="Region / language"
                    locale={locale}
                    class="border border-gray-300 rounded px-2 py-1 text-sm md:text-base font-semibold"
                />
            </div>
        </div>

        <div class="space-y-6">
            <div>
                <h2 class="text-2xl font-bold mb-2">About the artwork</h2>
                <div class="space-y-2">
                    {(productsData[product.metadata.sku]?.about ?? [product.description]).map(p => (
                        <p>{p}</p>
                    ))}
                </div>
            </div>
            <div>
                <h2 class="text-2xl font-bold mb-2"><label for="price-id">Size</label></h2>
                <select id="price-id" name="price-id" data-currency={currency} class="w-full px-3 py-3 border border-gray-300 rounded-md mb-2 appearance-none font-semibold">
                    <option value={product.default_price.id}>
                        {sizeToDescription[product.metadata.size]} - {
                            formatCurrency({
                                value: product.default_price.currency_options[currency].unit_amount,
                                currency,
                            })
                        }
                    </option>
                </select>
                <p class="mb-1">The image is <strong>printed full bleed</strong> with <strong>no border</strong>. Any frames shown in images are for display purposes only.</p>
            </div>
            <div>
                <h2 class="text-2xl font-bold mb-2">Fine art printing</h2>
                <div class="space-y-2">
                    <p>Your print is produced using <strong>Giclée printing</strong>, a premium technique that sprays microscopic droplets of <strong>archival ink</strong> onto the paper to achieve <em>vivid, lifelike colour and exceptional detail</em>.</p>
                    <p>This ensures your print captures every nuance of the original artwork, bringing its <em>bold, vibrant energy</em> into your space.</p>
                </div>
            </div>
            {productsData[product.metadata.sku]?.framing?.length ? (
                <div>
                    <h2 class="text-2xl font-bold mb-2">Framing</h2>
                    <div class="space-y-2">
                        {productsData[product.metadata.sku].framing.map(p => (
                            <p>{p}</p>
                        ))}
                    </div>
                </div>
            ) : <></>}
            <div>
                <h2 class="text-2xl font-bold mb-2">Shipping</h2>
                <div class="space-y-2">
                    <p>Enjoy <strong>free shipping</strong> with top-quality packaging to ensure your artwork arrives in perfect condition.</p>
                    <p>Your print will be delivered to your doorstep in about <em>1–2 weeks within the UK</em>, and <em>2–3 weeks outside the UK</em>.</p>
                    <p><em>If you're ordering from outside the UK, your shipment may be subject to import duties, taxes and fees. These aren't collected at checkout and will be payable by you upon delivery.</em></p>
                </div>
            </div>
            <div>
                <h2 class="text-2xl font-bold mb-2">{
                    formatCurrency({ value: product.default_price.currency_options[currency].unit_amount, currency })
                }</h2>
                <p><em>Apply promotion codes in the cart page.</em></p>
            </div>
            <Button id="submit-button-desktop" buttonText="Add to cart" errorMessage="There was an error creating your session. Please try again." />
        </div>
    </form>
</div>
</BaseLayout>

<script>
    import type { Currency } from "@utils/stripe"
    import { addToCart } from "@scripts/cart"
    import * as Sentry from "@sentry/astro"

    document.addEventListener("astro:page-load", async () => {
        const priceForm = document.querySelector("#price-form") as HTMLFormElement
        if (!priceForm) return

        const desktopButton = priceForm.querySelector("#submit-button-desktop") as HTMLButtonElement | null
        const mobileButton = document.querySelector("#submit-button-mobile") as HTMLButtonElement | null

        const buttons: HTMLButtonElement[] = [desktopButton, mobileButton].filter(Boolean) as HTMLButtonElement[]

        const getSpinnerFor = (btn: HTMLButtonElement) => btn.querySelector("#loading-spinner") as HTMLElement
        const getErrorFor = (btn: HTMLButtonElement) => (btn.parentElement?.querySelector("#error-message") as HTMLElement)

        // initialise UI state for all buttons
        for (const btn of buttons) {
            const sp = getSpinnerFor(btn)
            const err = getErrorFor(btn)
            sp?.classList.add("hidden")
            err?.classList.add("hidden")
            btn.disabled = false
        }

        priceForm.addEventListener("submit", async e => {
            e.preventDefault()
            for (const btn of buttons) {
                btn.disabled = true
                const sp = getSpinnerFor(btn)
                const err = getErrorFor(btn)
                sp?.classList.remove("hidden")
                err?.classList.add("hidden")
            }

            const priceIdElement = document.querySelector("#price-id") as HTMLInputElement
            const priceId = priceIdElement.value
            const currency = priceIdElement.dataset.currency as Currency

            const response = await addToCart({ priceId, currency })
            if (response?.error) {
                try {
                    Sentry.captureMessage("addToCart failed", {
                        level: "error",
                        extra: {
                            error: response.error,
                            priceId,
                            currency,
                            pathname: window.location.pathname,
                        },
                    })
                } catch (_) {
                    // ignore Sentry errors, continue UX fallback
                }
                for (const btn of buttons) {
                    const sp = getSpinnerFor(btn)
                    const err = getErrorFor(btn)
                    err?.classList.remove("hidden")
                    sp?.classList.add("hidden")
                    btn.disabled = false
                }
                return
            }
        })
    })
</script>
